{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}Exams - TaskCert{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-4 align-items-center">
        <div class="col-md-8">
            <h2 class="fw-bold section-title"><i class="fas fa-edit me-2"></i>Examinations</h2>
            <p class="text-muted">Take exams to earn your certifications</p>
        </div>
    </div>

    <div class="row">
        {% for exam in exams %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="exam-card">
                <div class="exam-card-header">
                    <h5 style="color: var(--primary); font-weight: 700;">
                        <i class="fas fa-graduation-cap"></i> {{ exam.name }}
                    </h5>
                    <p class="text-muted mb-0">{{ exam.created_by.name }}</p>
                </div>
                <div class="exam-card-body">
                    <p class="mb-4 text-muted">{{ exam.description|default:"Test your knowledge." }}</p>

                    <div class="d-flex flex-column gap-2 mb-4">
                        <div class="d-flex align-items-center gap-2 text-muted">
                            <i class="fas fa-list text-primary" style="width:20px"></i>
                            <span><strong>{{ exam.questions.count }}</strong> Questions</span>
                        </div>
                        <div class="d-flex align-items-center gap-2 text-muted">
                            <i class="fas fa-hourglass-half text-primary" style="width:20px"></i>
                            <span><strong>{{ exam.duration_minutes }}</strong> Minutes</span>
                        </div>
                        <div class="d-flex align-items-center gap-2 text-muted">
                            <i class="fas fa-check-circle text-primary" style="width:20px"></i>
                            <span>Pass Score: <strong>{{ exam.pass_score }}%</strong></span>
                        </div>
                    </div>

                    <div class="d-flex gap-2 flex-wrap mb-4">
                        <span class="badge bg-light text-primary border">
                            <i class="fas fa-star text-warning"></i> High Value
                        </span>
                        <span class="badge bg-light text-primary border">
                            <i class="fas fa-rotate"></i> Attempts: {{ attempt_counts|dict_get:exam.id|default:"0" }}
                        </span>
                    </div>

                    <div class="mt-auto">
                        {% if not user.is_staff %}
                        <button class="btn btn-primary w-100 py-2 fw-bold start-exam-btn" data-exam-id="{{ exam.id }}"
                            data-exam-duration="{{ exam.duration_minutes }}" data-bs-toggle="modal"
                            data-bs-target="#examModal{{ exam.id }}">
                            <i class="fas fa-play-circle"></i> Start Exam
                        </button>
                        {% else %}
                        <a href="/manage-exams/" class="btn btn-secondary w-100">
                            <i class="fas fa-cog"></i> Manage
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Exam Modal -->
        <div class="modal fade" id="examModal{{ exam.id }}" data-bs-backdrop="static" data-bs-keyboard="false"
            tabindex="-1">
            <div class="modal-dialog modal-fullscreen">
                <div class="modal-content" style="position: relative;">

                    <!-- Intro Screen -->
                    <div id="examIntro{{ exam.id }}" class="exam-screen"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1070; background: white; display: flex;">
                        <div class="d-flex flex-column justify-content-center align-items-center p-5 w-100">
                            <div class="text-center" style="max-width: 600px;">
                                <i class="fas fa-file-signature text-primary mb-4" style="font-size: 5rem;"></i>
                                <h2 class="mb-3">{{ exam.name }}</h2>
                                <div class="alert alert-warning text-start">
                                    <h5><i class="fas fa-exclamation-triangle"></i> Exam Rules</h5>
                                    <ul class="mb-0">
                                        <li>This exam is proctored - fullscreen mode required</li>
                                        <li>Do not switch tabs or minimize the window</li>
                                        <li>Exam will auto-submit when timer expires</li>
                                        <li>All activity is monitored and recorded</li>
                                    </ul>
                                </div>
                                <button class="btn btn-primary btn-lg px-5 mt-4 begin-exam-btn"
                                    data-exam-id="{{ exam.id }}">
                                    I Understand - Start Exam
                                </button>
                                <button class="btn btn-outline-secondary mt-3" data-bs-dismiss="modal">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Loading Screen -->
                    <div id="examLoading{{ exam.id }}" class="exam-screen"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1080; background: white; display: none;">
                        <div class="d-flex flex-column justify-content-center align-items-center h-100">
                            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
                            <h4 class="mt-3 text-muted">Preparing Your Exam...</h4>
                        </div>
                    </div>

                    <!-- Exam Interface -->
                    <div id="examInterface{{ exam.id }}" class="exam-screen"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1060; background: #f8f9fa; display: none; flex-direction: column;">
                        <!-- Top Bar -->
                        <div
                            class="bg-white border-bottom px-4 py-3 d-flex justify-content-between align-items-center shadow-sm">
                            <h5 class="m-0 fw-bold">{{ exam.name }}</h5>
                            <div class="d-flex align-items-center gap-3">
                                <div id="timer{{ exam.id }}" class="fs-4 fw-bold font-monospace">00:00</div>
                                <button class="btn btn-danger btn-sm submit-exam-btn" data-exam-id="{{ exam.id }}">
                                    Submit Exam
                                </button>
                            </div>
                        </div>

                        <!-- Main Content -->
                        <div class="flex-grow-1 overflow-hidden" style="display: flex;">
                            <!-- Question Area -->
                            <div class="flex-grow-1 p-4 overflow-auto bg-white">
                                <div id="questionArea{{ exam.id }}" style="max-width: 900px; margin: 0 auto;">
                                    <!-- Questions rendered by JS -->
                                </div>

                                <!-- Navigation Buttons -->
                                <div class="d-flex justify-content-between mt-5 pt-3 border-top"
                                    style="max-width: 900px; margin: 0 auto;">
                                    <button class="btn btn-outline-primary px-4 prev-btn" data-exam-id="{{ exam.id }}">
                                        <i class="fas fa-chevron-left"></i> Previous
                                    </button>
                                    <div>
                                        <button class="btn btn-outline-danger me-2 clear-btn"
                                            data-exam-id="{{ exam.id }}">
                                            Clear Answer
                                        </button>
                                        <button class="btn btn-outline-warning review-btn" data-exam-id="{{ exam.id }}">
                                            <i class="far fa-flag"></i> Mark for Review
                                        </button>
                                    </div>
                                    <button class="btn btn-primary px-4 next-btn" data-exam-id="{{ exam.id }}">
                                        Next <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Question Palette -->
                            <div class="border-start p-3 bg-light" style="width: 280px; overflow-auto;">
                                <h6 class="fw-bold mb-3">Question Palette</h6>
                                <div id="palette{{ exam.id }}" class="d-flex flex-wrap gap-2">
                                    <!-- Palette buttons rendered by JS -->
                                </div>
                                <div class="mt-4 small text-muted">
                                    <div class="mb-2"><span class="badge bg-success"
                                            style="width:12px;height:12px;"></span> Answered</div>
                                    <div class="mb-2"><span class="badge bg-warning"
                                            style="width:12px;height:12px;"></span> Marked</div>
                                    <div class="mb-2"><span class="badge bg-outline-danger"
                                            style="width:12px;height:12px;"></span> Not Answered</div>
                                    <div class="mb-2"><span class="badge bg-light border"
                                            style="width:12px;height:12px;"></span> Not Visited</div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Exam State Management
    const examStates = {};

    function initExamState(examId) {
        if (!examStates[examId]) {
            examStates[examId] = {
                attemptId: null,
                questions: [],
                currentIndex: 0,
                answers: {},
                marked: new Set(),
                visited: new Set(),
                timerSeconds: 0,
                timerInterval: null
            };
        }
        return examStates[examId];
    }

    // Start Exam Session
    document.querySelectorAll('.begin-exam-btn').forEach(btn => {
        btn.addEventListener('click', async function () {
            const examId = this.dataset.examId;
            const state = initExamState(examId);

            // Hide intro, show loading
            document.getElementById(`examIntro${examId}`).style.display = 'none';
            document.getElementById(`examLoading${examId}`).style.display = 'flex';

            try {
                const csrf = getCookie('csrftoken');
                const response = await fetch('/api/results/start_exam/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrf
                    },
                    body: JSON.stringify({ exam_id: examId })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to start exam');
                }

                // Initialize exam state
                state.attemptId = data.attempt_id;
                state.questions = data.questions || [];
                state.timerSeconds = data.duration_seconds || 0;

                // Render exam
                renderPalette(examId);
                loadQuestion(examId, 0);
                startTimer(examId);

                // Enter fullscreen
                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(() => { });
                }

                // Show exam interface
                document.getElementById(`examLoading${examId}`).style.display = 'none';
                document.getElementById(`examInterface${examId}`).style.display = 'flex';

            } catch (error) {
                console.error('Start exam error:', error);
                document.getElementById(`examLoading${examId}`).innerHTML =
                    `<div class="text-danger p-5 text-center"><h4>Error</h4><p>${error.message}</p></div>`;
            }
        });
    });

    // Load Question
    function loadQuestion(examId, index) {
        const state = examStates[examId];
        if (index < 0 || index >= state.questions.length) return;

        state.currentIndex = index;
        state.visited.add(index);

        const q = state.questions[index];
        const savedAnswer = state.answers[q.id] || '';

        let html = `
        <div class="mb-4">
            <span class="badge bg-secondary mb-2">Question ${index + 1} of ${state.questions.length}</span>
            <h5 class="fw-bold">${escapeHtml(q.question_text)}</h5>
        </div>
    `;

        if (q.question_type === 'multiple_choice' || q.question_type === 'true_false') {
            html += '<div class="d-flex flex-column gap-2">';
            (q.options || []).forEach(opt => {
                const checked = savedAnswer === opt ? 'checked' : '';
                html += `
                <label class="p-3 border rounded d-flex align-items-center gap-2" style="cursor: pointer;">
                    <input type="radio" name="q${q.id}" value="${escapeHtml(opt)}" ${checked} 
                        class="form-check-input" data-qid="${q.id}">
                    <span>${escapeHtml(opt)}</span>
                </label>
            `;
            });
            html += '</div>';
        } else {
            html += `
            <textarea class="form-control" rows="5" placeholder="Type your answer..." 
                data-qid="${q.id}">${escapeHtml(savedAnswer)}</textarea>
        `;
        }

        document.getElementById(`questionArea${examId}`).innerHTML = html;

        // Attach event listeners
        document.querySelectorAll(`#questionArea${examId} input, #questionArea${examId} textarea`).forEach(input => {
            input.addEventListener('change', function () {
                const qId = this.dataset.qid;
                state.answers[qId] = this.value;
                updatePalette(examId);
            });
        });

        updatePalette(examId);
        updateButtons(examId);
    }

    // Render Palette
    function renderPalette(examId) {
        const state = examStates[examId];
        const palette = document.getElementById(`palette${examId}`);
        palette.innerHTML = '';

        state.questions.forEach((q, idx) => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm';
            btn.textContent = idx + 1;
            btn.style.width = '40px';
            btn.style.height = '40px';
            btn.id = `paletteBtn${examId}_${idx}`;
            btn.onclick = () => loadQuestion(examId, idx);
            palette.appendChild(btn);
        });

        updatePalette(examId);
    }

    // Update Palette Colors
    function updatePalette(examId) {
        const state = examStates[examId];
        state.questions.forEach((q, idx) => {
            const btn = document.getElementById(`paletteBtn${examId}_${idx}`);
            if (!btn) return;

            btn.className = 'btn btn-sm';

            if (idx === state.currentIndex) {
                btn.style.border = '2px solid var(--primary)';
            } else {
                btn.style.border = '1px solid #dee2e6';
            }

            if (state.marked.has(idx)) {
                btn.className += ' btn-warning text-white';
            } else if (state.answers[q.id]) {
                btn.className += ' btn-success text-white';
            } else if (state.visited.has(idx)) {
                btn.className += ' btn-outline-danger';
            } else {
                btn.className += ' btn-light';
            }
        });
    }

    // Update Navigation Buttons
    function updateButtons(examId) {
        const state = examStates[examId];
        document.querySelector(`.prev-btn[data-exam-id="${examId}"]`).disabled = state.currentIndex === 0;
        document.querySelector(`.next-btn[data-exam-id="${examId}"]`).disabled = state.currentIndex === state.questions.length - 1;

        const reviewBtn = document.querySelector(`.review-btn[data-exam-id="${examId}"]`);
        if (state.marked.has(state.currentIndex)) {
            reviewBtn.innerHTML = '<i class="fas fa-flag"></i> Unmark';
            reviewBtn.classList.remove('btn-outline-warning');
            reviewBtn.classList.add('btn-warning');
        } else {
            reviewBtn.innerHTML = '<i class="far fa-flag"></i> Mark for Review';
            reviewBtn.classList.remove('btn-warning');
            reviewBtn.classList.add('btn-outline-warning');
        }
    }

    // Navigation
    document.addEventListener('click', function (e) {
        if (e.target.closest('.prev-btn')) {
            const examId = e.target.closest('.prev-btn').dataset.examId;
            const state = examStates[examId];
            if (state.currentIndex > 0) loadQuestion(examId, state.currentIndex - 1);
        }
        if (e.target.closest('.next-btn')) {
            const examId = e.target.closest('.next-btn').dataset.examId;
            const state = examStates[examId];
            if (state.currentIndex < state.questions.length - 1) loadQuestion(examId, state.currentIndex + 1);
        }
        if (e.target.closest('.clear-btn')) {
            const examId = e.target.closest('.clear-btn').dataset.examId;
            const state = examStates[examId];
            const q = state.questions[state.currentIndex];
            delete state.answers[q.id];
            loadQuestion(examId, state.currentIndex);
        }
        if (e.target.closest('.review-btn')) {
            const examId = e.target.closest('.review-btn').dataset.examId;
            const state = examStates[examId];
            if (state.marked.has(state.currentIndex)) {
                state.marked.delete(state.currentIndex);
            } else {
                state.marked.add(state.currentIndex);
            }
            updatePalette(examId);
            updateButtons(examId);
        }
    });

    // Timer
    function startTimer(examId) {
        const state = examStates[examId];
        state.timerInterval = setInterval(() => {
            state.timerSeconds--;
            const mins = Math.floor(state.timerSeconds / 60);
            const secs = state.timerSeconds % 60;
            const timerEl = document.getElementById(`timer${examId}`);
            timerEl.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            if (state.timerSeconds < 300) timerEl.classList.add('text-danger');
            if (state.timerSeconds <= 0) submitExam(examId);
        }, 1000);
    }

    // Submit Exam
    document.querySelectorAll('.submit-exam-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const examId = this.dataset.examId;
            const state = examStates[examId];
            const answered = Object.keys(state.answers).length;
            const total = state.questions.length;
            if (confirm(`You have answered ${answered} of ${total} questions.\n\nAre you sure you want to submit?`)) {
                submitExam(examId);
            }
        });
    });

    async function submitExam(examId) {
        const state = examStates[examId];
        clearInterval(state.timerInterval);

        try {
            const csrf = getCookie('csrftoken');
            const response = await fetch('/api/results/submit_exam/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                },
                body: JSON.stringify({
                    attempt_id: state.attemptId,
                    answers: state.answers
                })
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to submit');
            }

            alert(`Exam Submitted Successfully!\n\nScore: ${data.score}%\nStatus: ${data.passed ? 'PASSED' : 'FAILED'}`);
            window.location.reload();

        } catch (error) {
            console.error('Submit error:', error);
            alert('Error submitting exam: ' + error.message);
        }
    }

    // Helper Functions
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}