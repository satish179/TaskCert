{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}Examing: {{ exam.name }} - TaskCert{% endblock %}

{% block extra_css %}
<style>
    /* Force Full Screen Immersion */
    .sidebar,
    .navbar,
    footer {
        display: none !important;
    }

    body {
        padding: 0 !important;
        overflow: hidden;
        /* Prevent body scroll */
    }

    #examInterface {
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Full Screen Exam Interface -->
<div id="examInterface" class="exam-screen"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 99999; background: #f8f9fa; display: flex; flex-direction: column;">
    <!-- Top Bar -->
    <div class="bg-white border-bottom px-4 py-3 d-flex justify-content-between align-items-center shadow-sm"
        style="height: 70px;">
        <div class="d-flex align-items-center gap-3">
            <h5 class="m-0 fw-bold text-dark">{{ exam.name }}</h5>
            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-3 py-2 rounded-pill">
                <i class="fas fa-video me-1"></i> Proctored Session
            </span>
        </div>
        <div class="d-flex align-items-center gap-4">
            <div id="timer" class="fs-4 fw-bold font-monospace text-primary">Loading...</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-grow-1 overflow-hidden" style="display: flex;">
        <!-- Question Area -->
        <div class="flex-grow-1 p-4 overflow-auto bg-white">
            <div id="questionArea" style="max-width: 900px; margin: 0 auto;">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Loading Exam Questions...</p>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-5 pt-3 border-top" style="max-width: 900px; margin: 0 auto;">
                <button class="btn btn-outline-primary px-4 prev-btn" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div>
                    <button class="btn btn-outline-danger me-2 clear-btn">
                        Clear Answer
                    </button>
                    <button class="btn btn-outline-warning review-btn">
                        <i class="far fa-flag"></i> Mark for Review
                    </button>
                </div>
                <button class="btn btn-primary px-4 next-btn" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Question Palette -->
        <div class="border-start p-3 bg-light" style="width: 280px; overflow-auto;">
            <h6 class="fw-bold mb-3">Question Palette</h6>
            <div id="palette" class="d-flex flex-wrap gap-2">
                <!-- Palette buttons rendered by JS -->
            </div>
            <div class="mt-4 small text-muted">
                <div class="mb-2"><span class="badge bg-success" style="width:12px;height:12px;"></span> Answered</div>
                <div class="mb-2"><span class="badge bg-warning" style="width:12px;height:12px;"></span> Marked</div>
                <div class="mb-2"><span class="badge bg-outline-danger" style="width:12px;height:12px;"></span> Not
                    Answered</div>
                <div class="mb-2"><span class="badge bg-light border" style="width:12px;height:12px;"></span> Not
                    Visited</div>
            </div>
        </div>
    </div>
</div>

<!-- Intro Modal (Shows on Load) -->
<!-- Intro Overlay (Custom, no Bootstrap Modal) -->
<div id="introOverlay"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 100000; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center;">
    <div class="text-center" style="max-width: 600px;">
        <i class="fas fa-file-signature text-primary mb-4" style="font-size: 5rem;"></i>
        <h2 class="mb-3">{{ exam.name }}</h2>
        <div class="alert alert-warning text-start">
            <h5><i class="fas fa-exclamation-triangle"></i> Exam Rules</h5>
            <ul class="mb-0">
                <li>This exam is proctored - fullscreen mode required</li>
                <li>Do not switch tabs or minimize the window</li>
                <li>Exam will auto-submit when timer expires</li>
                <li>All activity is monitored and recorded</li>
            </ul>
        </div>
        <button id="startBtn" class="btn btn-primary btn-lg px-5 mt-4">
            I Understand - Start Exam
        </button>
        <a href="/exams/" class="btn btn-outline-secondary mt-3">Cancel / Go Back</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const EXAM_ID = "{{ exam.id }}";
    const STATE = {
        attemptId: null,
        questions: [],
        currentIndex: 0,
        answers: {},
        marked: new Set(),
        visited: new Set(),
        timerSeconds: 0,
        timerInterval: null
    };

    // On Load: Manage Intro Overlay
    document.addEventListener('DOMContentLoaded', () => {
        const introOverlay = document.getElementById('introOverlay');

        document.getElementById('startBtn').addEventListener('click', () => {
            introOverlay.style.display = 'none'; // Hide overlay
            startExam();
        });
    });

    async function startExam() {
        try {
            // Request Fullscreen
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(() => { });
            }

            const csrf = getCookie('csrftoken');
            const response = await fetch('/api/results/start_exam/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                },
                body: JSON.stringify({ exam_id: EXAM_ID })
            });

            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'Failed to start');

            STATE.attemptId = data.attempt_id;
            STATE.questions = data.questions || [];
            STATE.timerSeconds = data.duration_seconds || 0;

            renderPalette();
            loadQuestion(0);
            startTimer();

        } catch (error) {
            alert("Error starting exam: " + error.message);
            window.location.href = "/exams/";
        }
    }

    function loadQuestion(index) {
        if (index < 0 || index >= STATE.questions.length) return;

        STATE.currentIndex = index;
        STATE.visited.add(index);

        const q = STATE.questions[index];
        const savedAnswer = STATE.answers[q.id] || '';

        let html = `
        <div class="mb-4">
            <span class="badge bg-secondary mb-2">Question ${index + 1} of ${STATE.questions.length}</span>
            <h5 class="fw-bold">${escapeHtml(q.question_text)}</h5>
        </div>
    `;

        if (q.question_type === 'multiple_choice' || q.question_type === 'true_false') {
            html += '<div class="d-flex flex-column gap-2">';
            (q.options || []).forEach(opt => {
                const checked = savedAnswer === opt ? 'checked' : '';
                html += `
                <label class="p-3 border rounded d-flex align-items-center gap-2" style="cursor: pointer;">
                    <input type="radio" name="q${q.id}" value="${escapeHtml(opt)}" ${checked} 
                        class="form-check-input" data-qid="${q.id}">
                    <span>${escapeHtml(opt)}</span>
                </label>
            `;
            });
            html += '</div>';
        } else {
            html += `
            <textarea class="form-control" rows="5" placeholder="Type your answer..." 
                data-qid="${q.id}">${escapeHtml(savedAnswer)}</textarea>
        `;
        }

        document.getElementById(`questionArea`).innerHTML = html;

        // Attach event listeners
        document.querySelectorAll(`#questionArea input, #questionArea textarea`).forEach(input => {
            input.addEventListener('change', function () {
                const qId = this.dataset.qid;
                STATE.answers[qId] = this.value;
                updatePalette();
            });
        });

        updatePalette();
        updateButtons();
    }

    function renderPalette() {
        const palette = document.getElementById(`palette`);
        palette.innerHTML = '';

        STATE.questions.forEach((q, idx) => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sm';
            btn.textContent = idx + 1;
            btn.style.width = '40px';
            btn.style.height = '40px';
            btn.id = `paletteBtn_${idx}`;
            btn.onclick = () => loadQuestion(idx);
            palette.appendChild(btn);
        });
        updatePalette();
    }

    function updatePalette() {
        STATE.questions.forEach((q, idx) => {
            const btn = document.getElementById(`paletteBtn_${idx}`);
            if (!btn) return;

            btn.className = 'btn btn-sm';

            if (idx === STATE.currentIndex) {
                btn.style.border = '2px solid var(--primary)';
            } else {
                btn.style.border = '1px solid #dee2e6';
            }

            if (STATE.marked.has(idx)) {
                btn.className += ' btn-warning text-white';
            } else if (STATE.answers[q.id]) {
                btn.className += ' btn-success text-white';
            } else if (STATE.visited.has(idx)) {
                btn.className += ' btn-outline-danger';
            } else {
                btn.className += ' btn-light';
            }
        });
    }

    function updateButtons() {
        document.querySelector(`.prev-btn`).disabled = STATE.currentIndex === 0;

        const nextBtn = document.querySelector(`.next-btn`);
        if (STATE.currentIndex === STATE.questions.length - 1) {
            nextBtn.innerHTML = 'Submit Exam <i class="fas fa-check-circle"></i>';
            nextBtn.classList.remove('btn-primary');
            nextBtn.classList.add('btn-success');
            nextBtn.onclick = () => { if (confirm(`Submit Exam?`)) submitExam(); };
        } else {
            nextBtn.innerHTML = 'Next <i class="fas fa-chevron-right"></i>';
            nextBtn.classList.remove('btn-success');
            nextBtn.classList.add('btn-primary');
            nextBtn.disabled = false;
            nextBtn.onclick = () => loadQuestion(STATE.currentIndex + 1);
        }

        const reviewBtn = document.querySelector(`.review-btn`);
        if (STATE.marked.has(STATE.currentIndex)) {
            reviewBtn.innerHTML = '<i class="fas fa-flag"></i> Unmark';
            reviewBtn.classList.remove('btn-outline-warning');
            reviewBtn.classList.add('btn-warning');
        } else {
            reviewBtn.innerHTML = '<i class="far fa-flag"></i> Mark for Review';
            reviewBtn.classList.remove('btn-warning');
            reviewBtn.classList.add('btn-outline-warning');
        }
    }

    // Global Nav Listeners
    document.querySelector('.prev-btn').onclick = () => loadQuestion(STATE.currentIndex - 1);
    // Next btn listener is handled dynamically in updateButtons
    document.querySelector('.review-btn').onclick = () => {
        if (STATE.marked.has(STATE.currentIndex)) STATE.marked.delete(STATE.currentIndex);
        else STATE.marked.add(STATE.currentIndex);
        updatePalette();
        updateButtons();
    };
    document.querySelector('.clear-btn').onclick = () => {
        delete STATE.answers[STATE.questions[STATE.currentIndex].id];
        loadQuestion(STATE.currentIndex);
    };
    document.querySelector('.submit-exam-btn').onclick = () => {
        if (confirm(`Submit Exam?`)) submitExam();
    };

    function startTimer() {
        STATE.timerInterval = setInterval(() => {
            STATE.timerSeconds--;
            const mins = Math.floor(STATE.timerSeconds / 60);
            const secs = STATE.timerSeconds % 60;
            const timerEl = document.getElementById(`timer`);
            timerEl.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            if (STATE.timerSeconds <= 0) submitExam();
        }, 1000);
    }

    // Proctoring Logic - Aggressive Mode
    const WARNING_LIMIT = 3;
    let warnings = 0;

    // Create Warning Overlay dynamically if not exists
    const warningOverlay = document.createElement('div');
    warningOverlay.id = 'warningOverlay';
    warningOverlay.style.cssText = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(220,53,69,0.95);z-index:200000;display:none;flex-direction:column;justify-content:center;align-items:center;color:white;text-align:center;';
    warningOverlay.innerHTML = `
        <i class="fas fa-exclamation-triangle fa-5x mb-4"></i>
        <h1 class="fw-bold">VIOLATION DETECTED</h1>
        <h3 id="warningReason" class="mb-4"></h3>
        <div id="warningCount" class="display-1 fw-bold mb-4"></div>
        <p class="fs-4">Return to Fullscreen immediately to continue.</p>
        <button id="resumeBtn" class="btn btn-light btn-lg px-5 fw-bold text-danger mt-4">I Understand - Resume Exam</button>
    `;
    document.body.appendChild(warningOverlay);

    document.getElementById('resumeBtn').onclick = () => {
        warningOverlay.style.display = 'none';
        try {
            if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen().catch(() => { });
        } catch (e) { }
    };

    function triggerWarning(reason) {
        // Ignore if already showing warning or if exam hasn't started (overlay active)
        if (warningOverlay.style.display === 'flex') return;
        if (document.getElementById('introOverlay').style.display !== 'none') return;

        warnings++;

        if (warnings >= WARNING_LIMIT) {
            warningOverlay.innerHTML = `
                <i class="fas fa-ban fa-5x mb-4"></i>
                <h1 class="fw-bold">EXAM TERMINATED</h1>
                <h3 class="mb-4">Multiple Violations Detected</h3>
                <p class="fs-4">You have exceeded the warning limit.</p>
                <div class="spinner-border text-light mt-4"></div>
            `;
            warningOverlay.style.display = 'flex';
            setTimeout(() => submitExam(true), 1500); // Disqualified
        } else {
            document.getElementById('warningReason').textContent = reason;
            document.getElementById('warningCount').textContent = `${warnings}/${WARNING_LIMIT}`;
            warningOverlay.style.display = 'flex';
        }

        // Log to backend (optional, skipped for now to save bandwidth)
        console.warn(`Proctoring Warning: ${reason} (${warnings}/${WARNING_LIMIT})`);
    }

    // Event Listeners for Tab Switching / Visibility
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) triggerWarning("Tab Switch / Window Minimized");
    });
    window.addEventListener('blur', () => {
        // triggerWarning("Focus Lost (Alt+Tab)"); // Too aggressive? Maybe, but requested.
        // Only trigger if actually hidden or fullscreen lost to avoid false positives on some systems
        if (document.hidden) triggerWarning("Focus Lost");
    });

    // Event Listeners for Fullscreen - Vendor Prefixed
    function checkFullscreen() {
        // If exam started
        if (document.getElementById('introOverlay').style.display === 'none') {
            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
            if (!isFullscreen) {
                triggerWarning("Exited Fullscreen Mode");
            }
        }
    }

    document.addEventListener('fullscreenchange', checkFullscreen);
    document.addEventListener('webkitfullscreenchange', checkFullscreen);
    document.addEventListener('mozfullscreenchange', checkFullscreen);
    document.addEventListener('MSFullscreenChange', checkFullscreen);

    // Aggressive Polling (Backup for missing events)
    setInterval(() => {
        if (document.getElementById('introOverlay').style.display === 'none') {
            const isFullscreen = document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement;
            if (!isFullscreen) triggerWarning("Fullscreen Required (Check)");
            if (document.hidden) triggerWarning("Tab Inactive (Check)");
        }
    }, 2000);

    // ... (Existing timer/logic) ...

    async function submitExam(disqualified = false) {
        clearInterval(STATE.timerInterval);
        try {
            const csrf = getCookie('csrftoken');
            const response = await fetch('/api/results/submit_exam/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                },
                body: JSON.stringify({
                    attempt_id: STATE.attemptId,
                    answers: STATE.answers,
                    disqualified: disqualified
                })
            });
            const data = await response.json();
            // Redirect to dedicated result page
            window.location.href = `/exam/result/${STATE.attemptId}/`;
        } catch (e) {
            alert("Submission failed: " + e.message);
            window.location.href = "/exams/"; // Fallback
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
{% endblock %}