{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}

{% block title %}Examing: {{ exam.name }} - TaskCert{% endblock %}

{% block extra_css %}
<style>
    /* Force Full Screen Immersion */
    .sidebar,
    .navbar,
    footer {
        display: none !important;
    }

    body {
        padding: 0 !important;
        overflow: hidden;
        /* Prevent body scroll */
    }

    #examInterface {
        top: 0 !important;
        left: 0 !important;
        width: 100vw !important;
        height: 100vh !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- Full Screen Exam Interface -->
<div id="examInterface" class="exam-screen"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 99999; background: #f8f9fa; display: flex; flex-direction: column;">
    <!-- Top Bar -->
    <div class="bg-white border-bottom px-4 py-3 d-flex justify-content-between align-items-center shadow-sm"
        style="height: 70px;">
        <div class="d-flex align-items-center gap-3">
            <h5 class="m-0 fw-bold text-dark">{{ exam.name }}</h5>
            <span class="badge bg-danger bg-opacity-10 text-danger border border-danger px-3 py-2 rounded-pill">
                <i class="fas fa-video me-1"></i> Proctored Session
            </span>
        </div>
        <div class="d-flex align-items-center gap-4">
            <div id="timer" class="fs-4 fw-bold font-monospace text-primary">Loading...</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-grow-1 overflow-hidden" style="display: flex;">
        <!-- Question Area -->
        <div class="flex-grow-1 p-4 overflow-auto bg-white">
            <div id="questionArea" style="max-width: 900px; margin: 0 auto;">
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-3">Loading Exam Questions...</p>
                </div>
            </div>

            <!-- Navigation Buttons -->
            <div class="d-flex justify-content-between mt-5 pt-3 border-top" style="max-width: 900px; margin: 0 auto;">
                <button class="btn btn-outline-primary px-4 prev-btn" disabled>
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <div>
                    <button class="btn btn-outline-danger me-2 clear-btn">
                        Clear Answer
                    </button>
                    <button class="btn btn-outline-warning review-btn">
                        <i class="far fa-flag"></i> Mark for Review
                    </button>
                </div>
                <button class="btn btn-primary px-4 next-btn" disabled>
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <!-- Question Palette -->
        <div class="border-start p-3 bg-light" style="width: 280px; overflow-auto;">
            <h6 class="fw-bold mb-3">Question Palette</h6>
            <div id="palette" class="d-flex flex-wrap gap-2">
                <!-- Palette buttons rendered by JS -->
            </div>
            <div class="mt-4 small text-muted">
                <div class="mb-2"><span class="badge bg-success" style="width:12px;height:12px;"></span> Answered</div>
                <div class="mb-2"><span class="badge bg-warning" style="width:12px;height:12px;"></span> Marked</div>
                <div class="mb-2"><span class="badge bg-outline-danger" style="width:12px;height:12px;"></span> Not
                    Answered</div>
                <div class="mb-2"><span class="badge bg-light border" style="width:12px;height:12px;"></span> Not
                    Visited</div>
            </div>
        </div>
    </div>
</div>

<!-- Intro Modal (Shows on Load) -->
<!-- Intro Overlay (Custom, no Bootstrap Modal) -->
<div id="introOverlay"
    style="position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 100000; background: white; display: flex; flex-direction: column; justify-content: center; align-items: center;">
    <div class="text-center" style="max-width: 600px;">
        <i class="fas fa-file-signature text-primary mb-4" style="font-size: 5rem;"></i>
        <h2 class="mb-3">{{ exam.name }}</h2>
        <div class="alert alert-warning text-start">
            <h5><i class="fas fa-exclamation-triangle"></i> Exam Rules</h5>
            <ul class="mb-0">
                <li>This exam is proctored - fullscreen mode required</li>
                <li>Do not switch tabs or minimize the window</li>
                <li>Exam will auto-submit when timer expires</li>
                <li>All activity is monitored and recorded</li>
            </ul>
        </div>
        <button id="startBtn" class="btn btn-primary btn-lg px-5 mt-4">
            I Understand - Start Exam
        </button>
        <a href="/exams/" class="btn btn-outline-secondary mt-3">Cancel / Go Back</a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ==========================================
    // Core Configuration & State
    // ==========================================
    const CONFIG = {
        EXAM_ID: "{{ exam.id }}",
        WARNING_LIMIT: 3,
        POLL_INTERVAL_MS: 1000,
        API: {
            START: '/api/results/start_exam/',
            SUBMIT: '/api/results/submit_exam/'
        }
    };

    const STATE = {
        attemptId: null,
        questions: [],
        currentIndex: 0,
        answers: {},
        marked: new Set(),
        timerSeconds: 0,
        timerInterval: null,
        isExamActive: false
    };

    // ==========================================
    // Proctoring Manager (The "Enforcer")
    // ==========================================
    class ProctoringManager {
        constructor() {
            this.warnings = 0;
            this.overlay = this.createOverlay();
            this.isViolationActive = false;
        }

        createOverlay() {
            const div = document.createElement('div');
            div.id = 'proctorOverlay';
            div.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
                background: rgba(220, 53, 69, 0.98); z-index: 2147483647;
                display: none; flex-direction: column; justify-content: center; align-items: center;
                color: white; text-align: center; font-family: system-ui, -apple-system, sans-serif;
            `;
            div.innerHTML = `
                <i class="fas fa-exclamation-triangle fa-5x mb-4"></i>
                <h1 class="fw-bold display-4">VIOLATION DETECTED</h1>
                <h3 id="proctorReason" class="mb-4 text-uppercase tracking-wider">Reason</h3>
                <div id="proctorCount" class="display-1 fw-bold mb-4 bg-white text-danger rounded-circle d-flex align-items-center justify-content-center" style="width: 150px; height: 150px;">0/3</div>
                <p class="fs-4 px-3" style="max-width: 600px;">
                    You have violated the exam rules. Return to Fullscreen immediately.
                </p>
                <button id="resumeExamBtn" class="btn btn-light btn-lg px-5 fw-bold text-danger mt-4 shadow-lg rounded-pill">
                    <i class="fas fa-undo me-2"></i> I Understand - Resume
                </button>
            `;
            document.body.appendChild(div);

            div.querySelector('#resumeExamBtn').onclick = () => this.attemptResume();
            return div;
        }

        start() {
            // Bind listeners
            document.addEventListener('visibilitychange', () => this.checkVisibility());
            window.addEventListener('blur', () => this.checkFocus());

            // Vendor-prefixed fullscreen listeners
            ['fullscreenchange', 'webkitfullscreenchange', 'mozfullscreenchange', 'MSFullscreenChange'].forEach(
                event => document.addEventListener(event, () => this.checkFullscreen())
            );

            // Aggressive Polling
            setInterval(() => this.pollStatus(), CONFIG.POLL_INTERVAL_MS);

            console.log("ðŸ›¡ï¸ Proctoring Started");
        }

        pollStatus() {
            if (!STATE.isExamActive || this.isViolationActive) return;

            if (document.hidden) this.triggerViolation("Tab Switched / Minimized");
            else if (!this.isFullscreen()) this.triggerViolation("Exited Fullscreen");
        }

        checkVisibility() {
            if (STATE.isExamActive && document.hidden) this.triggerViolation("Tab Switched");
        }

        checkFocus() {
            // Optional: Can be too sensitive, relying on visibility is usually safer for UX
            if (STATE.isExamActive && document.hidden) this.triggerViolation("Focus Lost");
        }

        checkFullscreen() {
            if (STATE.isExamActive && !this.isFullscreen()) this.triggerViolation("Exited Fullscreen Mode");
        }

        isFullscreen() {
            return document.fullscreenElement ||
                document.webkitFullscreenElement ||
                document.mozFullScreenElement ||
                document.msFullscreenElement;
        }

        triggerViolation(reason) {
            if (this.isViolationActive) return; // Already showing
            this.isViolationActive = true;
            this.warnings++;

            console.warn(`Violation: ${reason} (${this.warnings}/${CONFIG.WARNING_LIMIT})`);

            // Update UI
            document.getElementById('proctorReason').textContent = reason;
            document.getElementById('proctorCount').textContent = `${this.warnings}/${CONFIG.WARNING_LIMIT}`;

            if (this.warnings >= CONFIG.WARNING_LIMIT) {
                this.terminateExam();
            } else {
                this.overlay.style.display = 'flex';
            }
        }

        attemptResume() {
            // Force Fullscreen
            try {
                if (document.documentElement.requestFullscreen) document.documentElement.requestFullscreen();
                else if (document.documentElement.webkitRequestFullscreen) document.documentElement.webkitRequestFullscreen();
            } catch (e) { console.error(e); }

            // Small delay to allow fullscreen transition before checking
            setTimeout(() => {
                if (this.isFullscreen()) {
                    this.overlay.style.display = 'none';
                    this.isViolationActive = false;
                } else {
                    alert("You must allow Fullscreen to continue.");
                }
            }, 300);
        }

        terminateExam() {
            this.overlay.innerHTML = `
                <i class="fas fa-ban fa-5x mb-4"></i>
                <h1 class="fw-bold text-uppercase">Exam Terminated</h1>
                <h3 class="mb-3">Security Violation Limit Reached</h3>
                <div class="spinner-border text-light my-4" style="width: 3rem; height: 3rem;"></div>
                <p>Auto-submitting your answers...</p>
            `;
            this.overlay.style.display = 'flex';
            setTimeout(() => ExamEngine.submit(true), 1500);
        }
    }

    const Proctor = new ProctoringManager();

    // ==========================================
    // Exam Engine (Logic & UI)
    // ==========================================
    const ExamEngine = {
        async init() {
            const introOverlay = document.getElementById('introOverlay');
            document.getElementById('startBtn').addEventListener('click', async () => {
                try {
                    await this.requestFullscreen();
                } catch (e) { }

                introOverlay.style.display = 'none';
                STATE.isExamActive = true;
                Proctor.start();
                this.startSession();
            });
        },

        async requestFullscreen() {
            if (document.documentElement.requestFullscreen) await document.documentElement.requestFullscreen();
            else if (document.documentElement.webkitRequestFullscreen) await document.documentElement.webkitRequestFullscreen();
        },

        async startSession() {
            try {
                const csrf = this.getCookie('csrftoken');
                const res = await fetch(CONFIG.API.START, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
                    body: JSON.stringify({ exam_id: CONFIG.EXAM_ID })
                });

                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Init failed');

                STATE.attemptId = data.attempt_id;
                STATE.questions = data.questions || [];
                STATE.timerSeconds = data.duration_seconds || 0;

                this.renderPalette();
                this.loadQuestion(0);
                this.startTimer();

            } catch (e) {
                alert("Critical Error: " + e.message);
                window.location.href = '/exams/';
            }
        },

        loadQuestion(index) {
            if (index < 0 || index >= STATE.questions.length) return;

            STATE.currentIndex = index;
            // STATE.visited.add(index); // Optional: tracked by next/prev actions usually

            const q = STATE.questions[index];
            const savedVal = STATE.answers[q.id] || '';
            const area = document.getElementById('questionArea');

            // Render Header
            let html = `
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="badge bg-secondary">Question ${index + 1} of ${STATE.questions.length}</span>
                        <span class="text-muted small">ID: #${q.id}</span>
                    </div>
                    <h5 class="fw-bold" style="line-height: 1.6;">${this.escape(q.question_text)}</h5>
                </div>
            `;

            // Render Inputs
            if (q.question_type === 'multiple_choice' || q.question_type === 'true_false') {
                html += `<div class="d-flex flex-column gap-3">`;
                (q.options || []).forEach(opt => {
                    const isChecked = savedVal === opt ? 'checked' : '';
                    const activeClass = isChecked ? 'border-primary bg-primary bg-opacity-10' : 'border-2';

                    html += `
                    <label class="p-3 border rounded d-flex align-items-center gap-3 transition-all ${activeClass}" 
                           style="cursor: pointer; transition: all 0.2s;"
                           onclick="ExamEngine.selectOption(this, '${q.id}', '${this.escape(opt)}')">
                        <input type="radio" name="q_${q.id}" value="${this.escape(opt)}" ${isChecked} 
                            class="form-check-input mt-0" style="width: 1.2rem; height: 1.2rem;">
                        <span class="fs-6">${this.escape(opt)}</span>
                    </label>`;
                });
                html += `</div>`;
            } else {
                html += `
                <textarea class="form-control p-3 fs-6" rows="6" 
                    placeholder="Type your answer here..." 
                    oninput="ExamEngine.saveAnswer('${q.id}', this.value)">${this.escape(savedVal)}</textarea>
                `;
            }

            area.innerHTML = html;
            this.updateUI();
        },

        selectOption(labelEl, qId, val) {
            // Update visual state of all labels
            const container = labelEl.closest('div');
            container.querySelectorAll('label').forEach(l => {
                l.classList.remove('border-primary', 'bg-primary', 'bg-opacity-10');
            });
            // Select current
            labelEl.classList.add('border-primary', 'bg-primary', 'bg-opacity-10');
            labelEl.querySelector('input').checked = true;

            this.saveAnswer(qId, val);
        },

        saveAnswer(qId, val) {
            STATE.answers[qId] = val;
            this.updatePalette();
        },

        updateUI() {
            this.updatePalette();

            // Buttons
            const prev = document.querySelector('.prev-btn');
            const next = document.querySelector('.next-btn');
            const review = document.querySelector('.review-btn');

            prev.disabled = STATE.currentIndex === 0;
            prev.onclick = () => this.loadQuestion(STATE.currentIndex - 1);

            if (STATE.currentIndex === STATE.questions.length - 1) {
                next.innerHTML = '<i class="fas fa-paper-plane me-2"></i> Submit Exam';
                next.className = 'btn btn-success px-4 next-btn';
                next.onclick = () => { if (confirm("Are you sure you want to finish?")) this.submit(); };
            } else {
                next.innerHTML = 'Next <i class="fas fa-chevron-right ms-2"></i>';
                next.className = 'btn btn-primary px-4 next-btn';
                next.onclick = () => this.loadQuestion(STATE.currentIndex + 1);
            }

            // Review Button State
            if (STATE.marked.has(STATE.currentIndex)) {
                review.innerHTML = '<i class="fas fa-flag me-2"></i> Unmark';
                review.className = 'btn btn-warning text-white review-btn';
            } else {
                review.innerHTML = '<i class="far fa-flag me-2"></i> Mark for Review';
                review.className = 'btn btn-outline-warning review-btn';
            }
            review.onclick = () => {
                if (STATE.marked.has(STATE.currentIndex)) STATE.marked.delete(STATE.currentIndex);
                else STATE.marked.add(STATE.currentIndex);
                this.updateUI();
            };

            // Clear Button
            document.querySelector('.clear-btn').onclick = () => {
                const qId = STATE.questions[STATE.currentIndex].id;
                delete STATE.answers[qId];
                this.loadQuestion(STATE.currentIndex);
            };
        },

        renderPalette() {
            const container = document.getElementById('palette');
            container.innerHTML = '';

            STATE.questions.forEach((q, i) => {
                const btn = document.createElement('button');
                btn.id = `pal_${i}`;
                btn.className = 'btn btn-sm d-flex align-items-center justify-content-center fw-bold shadow-sm';
                btn.style.width = '38px';
                btn.style.height = '38px';
                btn.textContent = i + 1;
                btn.onclick = () => this.loadQuestion(i);
                container.appendChild(btn);
            });
            this.updatePalette();
        },

        updatePalette() {
            STATE.questions.forEach((q, i) => {
                const btn = document.getElementById(`pal_${i}`);
                if (!btn) return;

                let cls = 'btn-light border';
                if (STATE.answers[q.id]) cls = 'btn-success text-white border-0';
                if (STATE.marked.has(i)) cls = 'btn-warning text-white border-0';

                if (i === STATE.currentIndex) {
                    btn.classList.add('ring-active');
                    btn.style.border = '2px solid var(--primary)';
                    btn.style.transform = 'scale(1.1)';
                } else {
                    btn.style.border = '';
                    btn.style.transform = '';
                }

                btn.className = `btn btn-sm d-flex align-items-center justify-content-center fw-bold shadow-sm ${cls}`;
            });
        },

        startTimer() {
            STATE.timerInterval = setInterval(() => {
                STATE.timerSeconds--;
                if (STATE.timerSeconds <= 0) {
                    this.submit(true); // Auto submit
                    return;
                }
                const mins = Math.floor(STATE.timerSeconds / 60);
                const secs = STATE.timerSeconds % 60;
                document.getElementById('timer').textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;

                // Panic color for last minute
                if (STATE.timerSeconds < 60) document.getElementById('timer').classList.add('text-danger');
            }, 1000);
        },

        async submit(disqualified = false) {
            clearInterval(STATE.timerInterval);
            STATE.isExamActive = false; // Stop checks

            // Visual Feedback
            const nextBtn = document.querySelector('.next-btn');
            if (nextBtn) {
                nextBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Submitting...';
                nextBtn.disabled = true;
            }

            try {
                const csrf = this.getCookie('csrftoken');
                const res = await fetch(CONFIG.API.SUBMIT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
                    body: JSON.stringify({
                        attempt_id: STATE.attemptId,
                        answers: STATE.answers,
                        disqualified: disqualified
                    })
                });

                // Fallback Force Redirect if JSON fails
                try {
                    const data = await res.json();
                    window.location.href = `/exam/result/${STATE.attemptId || data.attempt_id}/`;
                } catch (e) {
                    console.error("JSON Parse Error", e);
                    window.location.href = `/exam/result/${STATE.attemptId}/`;
                }

            } catch (e) {
                alert("Network Error during submit. Redirecting...");
                window.location.href = `/exam/result/${STATE.attemptId}/`;
            }
        },

        getCookie(name) {
            let v = null;
            if (document.cookie && document.cookie !== '') {
                document.cookie.split(';').forEach(c => {
                    const ck = c.trim();
                    if (ck.substring(0, name.length + 1) === (name + '=')) {
                        v = decodeURIComponent(ck.substring(name.length + 1));
                    }
                });
            }
            return v;
        },

        escape(text) {
            const d = document.createElement('div');
            d.textContent = text;
            return d.innerHTML;
        }
    };

    // Initialize System
    ExamEngine.init();

</script>
{% endblock %}